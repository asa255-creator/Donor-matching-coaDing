function onOpen() {
  // Initialize all required sheets before showing menus
  initializeRequiredSheets_();

  const ui = SpreadsheetApp.getUi();

  // KREF menu stays the same
  ui.createMenu('KREF Tools')
    .addItem('Fetch donor info from KREF', 'exportAllToSheet')
    .addItem('Add downloaded FEC reports', 'fec_uploadDialog')
    .addToUi();

  // Donor Tools menu now includes your local functions plus the final donor ID list creator
  ui.createMenu('Donor Tools')
    .addItem('Run locally: prepare job and show Terminal command', 'dl_prepareLocalJobAndShowCommand_')
    .addItem('Continue training: add more labeled pairs', 'dl_prepareIncrementalTrainingJob_')
    .addItem('Open progress sidebar', 'dl_showProgressSidebar')
    .addSeparator()
    .addItem('üìä Analyze Matching Quality', 'diagnostic_analyzeMatching')
    .addSeparator()
    .addItem('Upload Campaign Deputy Export', 'cd_uploadDialog')
    .addItem('Match Donors to Campaign Deputy', 'cd_prepareMatchingJob_')
    .addSeparator()
    .addItem('Match Addresses to Districts', 'matchAddressesToDistricts')
    .addItem('Improve Geocode Cache', 'improveGeocodeCache')
    .addItem('Reset District Property Mappings', 'resetPropertyMappings')
    .addSeparator()
    .addItem('üß¨ Evolve Blocking Rules', 'dl_evolveBlockingRules_')
    .addSeparator()
    .addItem('üîç Show Sheet Diagnostics', 'troubleshoot_showSheetDiagnostics')
    .addItem('üîç Unhide All Sheets', 'troubleshoot_unhideAllSheets')
    .addToUi();
    // onOpen
SpreadsheetApp.getActive().toast(
  'Donor Tools loaded from ' + (ScriptApp.getService().getUrl() || '(no web app)'),
  'Info', 5
);

}

/**
 * Initialize all required sheets with proper headers
 * Called automatically on spreadsheet open
 * @private
 */
function initializeRequiredSheets_() {
  const ss = SpreadsheetApp.getActive();

  // Define all required sheets with their headers
  const sheetsConfig = {
    'KREF_Exports': {
      header: ['Recipient','DonorFirst','DonorLast','Address1','Address2','City','State','Zip','Amount','WeightedAmount','ReceiptDate','Occupation','Employer','DonationID'],
      format: '@' // Text format for all columns
    },
    'FEC_Exports': {
      header: ['Recipient','DonorFirst','DonorLast','Address1','Address2','City','State','Zip','Amount','WeightedAmount','ReceiptDate','Occupation','Employer','DonationID'],
      format: '@'
    },
    'Training': {
      header: ['Label', 'sheet_a','row_a','first_a','last_a','addr_a','city_a','state_a','zip_a','employer_a','occupation_a', 'sheet_b','row_b','first_b','last_b','addr_b','city_b','state_b','zip_b','employer_b','occupation_b'],
      frozenRows: 1
    },
    'Merge output': {
      header: ['Recipient', 'DonorFirst', 'DonorLast', 'Address1', 'Address2', 'City', 'State', 'Zip', 'Amount', 'WeightedAmount', 'ReceiptDate', 'Occupation', 'Employer', 'DonationID', 'DonorID', 'Confidence'],
      frozenRows: 1
    },
    'Options': {
      header: ['MinAmount', 'MaxAmount', 'MinDate', 'MaxDate', 'ContributionTypes', '', '', 'PercentLossPerYear', '', 'MatchThreshold'],
      defaultRow: [1, 249, '2018-07-01', '', 'INDIVIDUAL', '', '', '0', '', '0.7'],
      frozenRows: 1
    },
    'Candidates': {
      header: ['FirstName', 'LastName', 'Multiplier'],
      frozenRows: 1
    },
    'Organizations': {
      header: ['OrganizationName', 'Multiplier'],
      frozenRows: 1
    },
    '_GeocodeCache': {
      header: ['NormalizedAddress', 'Latitude', 'Longitude', 'Status', 'Source', 'DateAdded'],
      frozenRows: 1,
      hidden: true
    },
    'CD_To_Upload': {
      header: ['First', 'Last', 'Address', 'City', 'State', 'Zip', 'Federal District', 'State Senate District', 'State House District', 'County'],
      frozenRows: 1
    },
    'BlockingRules': {
      header: ['Rule Name', 'Fields', 'Transforms', 'Separator', 'Required Fields', 'Cohort', 'Score'],
      frozenRows: 1,
      defaultRules: true  // Flag to populate with default rules
    }
  };

  // Check and create each sheet
  for (const [sheetName, config] of Object.entries(sheetsConfig)) {
    let sheet = ss.getSheetByName(sheetName);
    let isNewSheet = false;

    if (!sheet) {
      // Create new sheet
      sheet = ss.insertSheet(sheetName);
      isNewSheet = true;
      Logger.log(`Created sheet: ${sheetName}`);
    }

    // Check if sheet is empty (no header in row 1)
    const needsHeader = isNewSheet || (sheet.getLastRow() === 0) ||
                        (sheet.getRange(1, 1).getValue() === '');

    // ONLY configure newly created sheets OR empty sheets
    if (needsHeader) {
      // Ensure enough columns
      const neededCols = config.header.length;
      if (sheet.getMaxColumns() < neededCols) {
        sheet.insertColumnsAfter(sheet.getMaxColumns(), neededCols - sheet.getMaxColumns());
      }

      // Write header
      sheet.getRange(1, 1, 1, config.header.length).setValues([config.header]);
      sheet.getRange(1, 1, 1, config.header.length).setFontWeight('bold').setBackground('#4285f4').setFontColor('#ffffff');
      Logger.log(`Added header to sheet: ${sheetName}`);

      // Add default row if specified (e.g., Options sheet)
      if (config.defaultRow) {
        sheet.getRange(2, 1, 1, config.defaultRow.length).setValues([config.defaultRow]);
      }

      // Apply formatting
      if (config.format) {
        const lastRow = Math.max(sheet.getLastRow(), 2);
        sheet.getRange(1, 1, lastRow, config.header.length).setNumberFormat(config.format);
      }

      // Freeze rows
      if (config.frozenRows) {
        sheet.setFrozenRows(config.frozenRows);
      }

      // Hide sheet if specified
      if (config.hidden) {
        sheet.hideSheet();
      }

      // Populate default blocking rules if specified
      if (config.defaultRules && sheetName === 'BlockingRules') {
        populateDefaultBlockingRules_(sheet);
      }
    }
  }
}

/**
 * Populate BlockingRules sheet with smarter default rules
 * @private
 */
function populateDefaultBlockingRules_(sheet) {
  // Define 50 intelligent blocking rules with conditional logic
  // Format: [Name, Fields, Transforms, Separator, Required Fields, Cohort, Score]
  const defaultRules = [
    // Cohort 1: Core name+location blocking (10 rules)
    ['Soundex Name + ZIP3', 'DonorFirst, DonorLast, Zip', 'soundex, soundex, zip3', '|', '', 1, 0],
    ['Soundex Last + Full ZIP', 'DonorLast, Zip', 'soundex, none', '|', 'Zip', 1, 0],
    ['Name + Address (if addr)', 'DonorFirst, DonorLast, Address1', 'first3, soundex, first5', '|', 'Address1', 1, 0],
    ['Name + City (fallback)', 'DonorFirst, DonorLast, City', 'first3, soundex, lower', '|', 'City', 1, 0],
    ['Last Token Name + ZIP', 'DonorFirst, DonorLast, Zip', 'last_token, last_token, none', '|', '', 1, 0],
    ['Soundex First + Address', 'DonorFirst, Address1, Zip', 'soundex, first5, zip3', '|', 'Address1', 1, 0],
    ['Full Name Initials + ZIP', 'DonorFirst, DonorLast, Zip', 'first2, first3, none', '|', '', 1, 0],
    ['Soundex Name + City', 'DonorFirst, DonorLast, City', 'soundex, soundex, lower', '|', '', 1, 0],
    ['First Token Names + State', 'DonorFirst, DonorLast, State', 'first_token, first_token, none', '|', '', 1, 0],
    ['Name Prefixes + ZIP3', 'DonorFirst, DonorLast, Zip', 'first4, first4, zip3', '|', 'Zip', 1, 0],

    // Cohort 2: Employer-based blocking (10 rules)
    ['Soundex Name + Employer', 'DonorFirst, DonorLast, Employer', 'soundex, soundex, employer_token', '|', 'Employer', 2, 0],
    ['Last + Employer + ZIP3', 'DonorLast, Employer, Zip', 'soundex, employer_token, zip3', '|', 'Employer,Zip', 2, 0],
    ['First + Employer Token', 'DonorFirst, Employer', 'first3, employer_token', '|', 'Employer', 2, 0],
    ['Employer + City', 'Employer, City', 'employer_token, lower', '|', 'Employer,City', 2, 0],
    ['Employer + Occupation + ZIP', 'Employer, Occupation, Zip', 'employer_token, first_token, zip3', '|', 'Employer,Occupation', 2, 0],
    ['Name + Occupation', 'DonorLast, Occupation', 'soundex, first_token', '|', 'Occupation', 2, 0],
    ['Employer + State', 'Employer, State', 'employer_token, none', '|', 'Employer', 2, 0],
    ['Last + Employer + State', 'DonorLast, Employer, State', 'first3, employer_token, none', '|', 'Employer', 2, 0],
    ['Occupation + City', 'Occupation, City', 'first_token, lower', '|', 'Occupation,City', 2, 0],
    ['First + Occupation + ZIP', 'DonorFirst, Occupation, Zip', 'soundex, first_token, zip3', '|', 'Occupation', 2, 0],

    // Cohort 3: Address-heavy blocking (10 rules)
    ['Address + Name', 'Address1, DonorLast', 'first5, soundex', '|', 'Address1', 3, 0],
    ['Address Token + ZIP', 'Address1, Zip', 'first_token, none', '|', 'Address1,Zip', 3, 0],
    ['Address + City + Last', 'Address1, City, DonorLast', 'first4, lower, first3', '|', 'Address1,City', 3, 0],
    ['Address Prefix + State', 'Address1, State', 'first3, none', '|', 'Address1', 3, 0],
    ['Address + Soundex Name', 'Address1, DonorFirst, DonorLast', 'first_token, soundex, soundex', '|', 'Address1', 3, 0],
    ['City + Address Token', 'City, Address1', 'lower, first_token', '|', 'Address1,City', 3, 0],
    ['ZIP3 + Address + Last', 'Zip, Address1, DonorLast', 'zip3, first5, soundex', '|', 'Address1', 3, 0],
    ['Address + State + First', 'Address1, State, DonorFirst', 'first5, none, first3', '|', 'Address1', 3, 0],
    ['Address Last Token + ZIP', 'Address1, Zip', 'last_token, none', '|', 'Address1,Zip', 3, 0],
    ['Address + Name Initials', 'Address1, DonorFirst, DonorLast', 'first4, first2, first2', '|', 'Address1', 3, 0],

    // Cohort 4: Geographic clustering (10 rules)
    ['City + Soundex Names', 'City, DonorFirst, DonorLast', 'lower, soundex, soundex', '|', 'City', 4, 0],
    ['ZIP3 + Last + First Init', 'Zip, DonorLast, DonorFirst', 'zip3, soundex, first2', '|', 'Zip', 4, 0],
    ['State + Name Tokens', 'State, DonorFirst, DonorLast', 'none, first_token, first_token', '|', '', 4, 0],
    ['City + ZIP3 + Last', 'City, Zip, DonorLast', 'lower, zip3, first3', '|', 'City,Zip', 4, 0],
    ['ZIP + Name Prefixes', 'Zip, DonorFirst, DonorLast', 'none, first3, first3', '|', 'Zip', 4, 0],
    ['State + City + Last', 'State, City, DonorLast', 'none, lower, soundex', '|', 'City', 4, 0],
    ['City + Last Token Name', 'City, DonorLast', 'lower, last_token', '|', 'City', 4, 0],
    ['ZIP3 + First Token Names', 'Zip, DonorFirst, DonorLast', 'zip3, first_token, first_token', '|', 'Zip', 4, 0],
    ['State + Soundex Last', 'State, DonorLast', 'none, soundex', '|', '', 4, 0],
    ['City + Name Initials', 'City, DonorFirst, DonorLast', 'lower, first2, first3', '|', 'City', 4, 0],

    // Cohort 5: Multi-field combinations (10 rules)
    ['Name + Addr + Employer', 'DonorLast, Address1, Employer', 'soundex, first4, employer_token', '|', 'Address1,Employer', 5, 0],
    ['ZIP3 + Name + Occupation', 'Zip, DonorLast, Occupation', 'zip3, soundex, first_token', '|', 'Occupation', 5, 0],
    ['City + Name + Employer', 'City, DonorFirst, DonorLast, Employer', 'lower, first3, soundex, employer_token', '|', 'Employer', 5, 0],
    ['Addr + City + Last', 'Address1, City, DonorLast', 'first5, lower, soundex', '|', 'Address1,City', 5, 0],
    ['Name + ZIP + Employer', 'DonorFirst, DonorLast, Zip, Employer', 'first3, soundex, zip3, employer_token', '|', 'Employer', 5, 0],
    ['State + Name + Occupation', 'State, DonorLast, Occupation', 'none, soundex, first_token', '|', 'Occupation', 5, 0],
    ['Addr + ZIP + Name', 'Address1, Zip, DonorFirst, DonorLast', 'first_token, none, first3, first3', '|', 'Address1', 5, 0],
    ['City + ZIP + Employer', 'City, Zip, Employer', 'lower, zip3, employer_token', '|', 'Employer', 5, 0],
    ['Name + City + Occupation', 'DonorFirst, DonorLast, City, Occupation', 'soundex, soundex, lower, first_token', '|', 'Occupation', 5, 0],
    ['Soundex All + ZIP3', 'DonorFirst, DonorLast, City, Zip', 'soundex, soundex, lower, zip3', '|', '', 5, 0]
  ];

  // Write the default rules starting from row 2 (7 columns now)
  sheet.getRange(2, 1, defaultRules.length, 7).setValues(defaultRules);
  Logger.log('Populated BlockingRules sheet with 50 intelligent conditional rules');
}

function onOpen() {
  // Initialize all required sheets before showing menus
  initializeRequiredSheets_();

  const ui = SpreadsheetApp.getUi();

  // KREF menu stays the same
  ui.createMenu('KREF Tools')
    .addItem('Fetch donor info from KREF', 'exportAllToSheet')
    .addItem('Add downloaded FEC reports', 'fec_uploadDialog')
    .addToUi();

  // Donor Tools menu now includes your local functions plus the final donor ID list creator
  ui.createMenu('Donor Tools')
    .addItem('Run locally: prepare job and show Terminal command', 'dl_prepareLocalJobAndShowCommand_')
    .addItem('Continue training: add more labeled pairs', 'dl_prepareIncrementalTrainingJob_')
    .addItem('Open progress sidebar', 'dl_showProgressSidebar')
    .addSeparator()
    .addItem('üìä Analyze Matching Quality', 'diagnostic_analyzeMatching')
    .addSeparator()
    .addItem('Upload Campaign Deputy Export', 'cd_uploadDialog')
    .addItem('Match Donors to Campaign Deputy', 'cd_prepareMatchingJob_')
    .addSeparator()
    .addItem('Match Addresses to Districts', 'matchAddressesToDistricts')
    .addItem('Improve Geocode Cache', 'improveGeocodeCache')
    .addItem('Reset District Property Mappings', 'resetPropertyMappings')
    .addSeparator()
    .addItem('üß¨ Evolve Blocking Rules', 'dl_evolveBlockingRules_')
    .addSeparator()
    .addItem('üîç Show Sheet Diagnostics', 'troubleshoot_showSheetDiagnostics')
    .addItem('üîç Unhide All Sheets', 'troubleshoot_unhideAllSheets')
    .addToUi();
    // onOpen
SpreadsheetApp.getActive().toast(
  'Donor Tools loaded from ' + (ScriptApp.getService().getUrl() || '(no web app)'),
  'Info', 5
);

}

/**
 * Initialize all required sheets with proper headers
 * Called automatically on spreadsheet open
 * @private
 */
function initializeRequiredSheets_() {
  const ss = SpreadsheetApp.getActive();

  // Define all required sheets with their headers
  const sheetsConfig = {
    'KREF_Exports': {
      header: ['Recipient','DonorFirst','DonorLast','Address1','Address2','City','State','Zip','Amount','WeightedAmount','ReceiptDate','Occupation','Employer','DonationID'],
      format: '@' // Text format for all columns
    },
    'FEC_Exports': {
      header: ['Recipient','DonorFirst','DonorLast','Address1','Address2','City','State','Zip','Amount','WeightedAmount','ReceiptDate','Occupation','Employer','DonationID'],
      format: '@'
    },
    'Training': {
      header: ['Label', 'sheet_a','row_a','first_a','last_a','addr_a','city_a','state_a','zip_a','employer_a','occupation_a', 'sheet_b','row_b','first_b','last_b','addr_b','city_b','state_b','zip_b','employer_b','occupation_b'],
      frozenRows: 1
    },
    'Merge output': {
      header: ['Recipient', 'DonorFirst', 'DonorLast', 'Address1', 'Address2', 'City', 'State', 'Zip', 'Amount', 'WeightedAmount', 'ReceiptDate', 'Occupation', 'Employer', 'DonationID', 'DonorID', 'Confidence'],
      frozenRows: 1
    },
    'Options': {
      header: ['MinAmount', 'MaxAmount', 'MinDate', 'MaxDate', 'ContributionTypes', '', '', 'PercentLossPerYear', '', 'MatchThreshold'],
      defaultRow: [1, 249, '2018-07-01', '', 'INDIVIDUAL', '', '', '0', '', '0.7'],
      frozenRows: 1
    },
    'Candidates': {
      header: ['FirstName', 'LastName', 'Multiplier'],
      frozenRows: 1
    },
    'Organizations': {
      header: ['OrganizationName', 'Multiplier'],
      frozenRows: 1
    },
    '_GeocodeCache': {
      header: ['NormalizedAddress', 'Latitude', 'Longitude', 'Status', 'Source', 'DateAdded'],
      frozenRows: 1,
      hidden: true
    },
    'CD_To_Upload': {
      header: ['First', 'Last', 'Address', 'City', 'State', 'Zip', 'Federal District', 'State Senate District', 'State House District', 'County'],
      frozenRows: 1
    },
    'BlockingRules': {
      header: ['Rule Name', 'Fields', 'Transforms', 'Separator', 'Cohort', 'Score'],
      frozenRows: 1,
      defaultRules: true  // Flag to populate with default rules
    }
  };

  // Check and create each sheet
  for (const [sheetName, config] of Object.entries(sheetsConfig)) {
    let sheet = ss.getSheetByName(sheetName);
    let isNewSheet = false;

    if (!sheet) {
      // Create new sheet
      sheet = ss.insertSheet(sheetName);
      isNewSheet = true;
      Logger.log(`Created sheet: ${sheetName}`);
    }

    // Check if sheet is empty (no header in row 1)
    const needsHeader = isNewSheet || (sheet.getLastRow() === 0) ||
                        (sheet.getRange(1, 1).getValue() === '');

    // ONLY configure newly created sheets OR empty sheets
    if (needsHeader) {
      // Ensure enough columns
      const neededCols = config.header.length;
      if (sheet.getMaxColumns() < neededCols) {
        sheet.insertColumnsAfter(sheet.getMaxColumns(), neededCols - sheet.getMaxColumns());
      }

      // Write header
      sheet.getRange(1, 1, 1, config.header.length).setValues([config.header]);
      sheet.getRange(1, 1, 1, config.header.length).setFontWeight('bold').setBackground('#4285f4').setFontColor('#ffffff');
      Logger.log(`Added header to sheet: ${sheetName}`);

      // Add default row if specified (e.g., Options sheet)
      if (config.defaultRow) {
        sheet.getRange(2, 1, 1, config.defaultRow.length).setValues([config.defaultRow]);
      }

      // Apply formatting
      if (config.format) {
        const lastRow = Math.max(sheet.getLastRow(), 2);
        sheet.getRange(1, 1, lastRow, config.header.length).setNumberFormat(config.format);
      }

      // Freeze rows
      if (config.frozenRows) {
        sheet.setFrozenRows(config.frozenRows);
      }

      // Hide sheet if specified
      if (config.hidden) {
        sheet.hideSheet();
      }

      // Populate default blocking rules if specified
      if (config.defaultRules && sheetName === 'BlockingRules') {
        populateDefaultBlockingRules_(sheet);
      }
    }
  }
}

/**
 * Populate BlockingRules sheet with default starting rules
 * @private
 */
function populateDefaultBlockingRules_(sheet) {
  // Define 50 diverse initial blocking rules (10 per cohort)
  const defaultRules = [
    // Cohort 1: High-performance single/double field rules (10 rules)
    ['Soundex First + Last', 'DonorFirst, DonorLast', 'soundex, soundex', '|', 1, 0],
    ['Soundex Last + Zip', 'DonorLast, Zip', 'soundex, none', '|', 1, 0],
    ['First 3 First + Soundex Last', 'DonorFirst, DonorLast', 'first3, soundex', '|', 1, 0],
    ['Soundex First + First 5 Address', 'DonorFirst, Address1', 'soundex, first5', '|', 1, 0],
    ['First Token Last + Zip', 'DonorLast, Zip', 'first_token, none', '|', 1, 0],
    ['Soundex First + City', 'DonorFirst, City', 'soundex, lower', '|', 1, 0],
    ['First 2 First + First 2 Last', 'DonorFirst, DonorLast', 'first2, first2', '|', 1, 0],
    ['Soundex Last + City', 'DonorLast, City', 'soundex, lower', '|', 1, 0],
    ['First Token Address + Zip', 'Address1, Zip', 'first_token, none', '|', 1, 0],
    ['First 4 First + Soundex Last', 'DonorFirst, DonorLast', 'first4, soundex', '|', 1, 0],

    // Cohort 2: Name-focused variations (10 rules)
    ['First 2 First + First 3 Last', 'DonorFirst, DonorLast', 'first2, first3', '|', 2, 0],
    ['Soundex First + First Token Last', 'DonorFirst, DonorLast', 'soundex, first_token', '|', 2, 0],
    ['First 3 First + First 3 Last + Zip', 'DonorFirst, DonorLast, Zip', 'first3, first3, none', '|', 2, 0],
    ['First Token First + Soundex Last', 'DonorFirst, DonorLast', 'first_token, soundex', '|', 2, 0],
    ['First 4 First + First 4 Last', 'DonorFirst, DonorLast', 'first4, first4', '|', 2, 0],
    ['Soundex First + First 2 Last + State', 'DonorFirst, DonorLast, State', 'soundex, first2, none', '|', 2, 0],
    ['First 5 First + Soundex Last', 'DonorFirst, DonorLast', 'first5, soundex', '|', 2, 0],
    ['First Token First + First Token Last', 'DonorFirst, DonorLast', 'first_token, first_token', '|', 2, 0],
    ['First 3 First + City', 'DonorFirst, City', 'first3, lower', '|', 2, 0],
    ['Soundex Last + First 2 First + State', 'DonorLast, DonorFirst, State', 'soundex, first2, none', '|', 2, 0],

    // Cohort 3: Address-focused variations (10 rules)
    ['First 5 Address + City', 'Address1, City', 'first5, lower', '|', 3, 0],
    ['First Token Address + City', 'Address1, City', 'first_token, lower', '|', 3, 0],
    ['First 3 Address + Zip', 'Address1, Zip', 'first3, none', '|', 3, 0],
    ['First Token Address + State', 'Address1, State', 'first_token, none', '|', 3, 0],
    ['First 4 Address + City', 'Address1, City', 'first4, lower', '|', 3, 0],
    ['First 2 Address + Zip', 'Address1, Zip', 'first2, none', '|', 3, 0],
    ['First Token Address + Soundex Last', 'Address1, DonorLast', 'first_token, soundex', '|', 3, 0],
    ['First 5 Address + State', 'Address1, State', 'first5, none', '|', 3, 0],
    ['First 3 Address + City', 'Address1, City', 'first3, lower', '|', 3, 0],
    ['First Token Address + First 2 Last', 'Address1, DonorLast', 'first_token, first2', '|', 3, 0],

    // Cohort 4: Geographic-focused variations (10 rules)
    ['City + Zip', 'City, Zip', 'lower, none', '|', 4, 0],
    ['State + Zip', 'State, Zip', 'none, none', '|', 4, 0],
    ['City + Soundex Last', 'City, DonorLast', 'lower, soundex', '|', 4, 0],
    ['Zip + First 3 Last', 'Zip, DonorLast', 'none, first3', '|', 4, 0],
    ['City + First 2 First', 'City, DonorFirst', 'lower, first2', '|', 4, 0],
    ['State + Soundex First + Soundex Last', 'State, DonorFirst, DonorLast', 'none, soundex, soundex', '|', 4, 0],
    ['Zip + First Token Last', 'Zip, DonorLast', 'none, first_token', '|', 4, 0],
    ['City + First Token First', 'City, DonorFirst', 'lower, first_token', '|', 4, 0],
    ['State + First 3 First + First 3 Last', 'State, DonorFirst, DonorLast', 'none, first3, first3', '|', 4, 0],
    ['Zip + First 2 First', 'Zip, DonorFirst', 'none, first2', '|', 4, 0],

    // Cohort 5: Three-field combinations (10 rules)
    ['Soundex First + Soundex Last + City', 'DonorFirst, DonorLast, City', 'soundex, soundex, lower', '|', 5, 0],
    ['First 3 First + First 3 Last + City', 'DonorFirst, DonorLast, City', 'first3, first3, lower', '|', 5, 0],
    ['Soundex First + First 3 Address + Zip', 'DonorFirst, Address1, Zip', 'soundex, first3, none', '|', 5, 0],
    ['First Token First + First Token Last + State', 'DonorFirst, DonorLast, State', 'first_token, first_token, none', '|', 5, 0],
    ['First 2 First + Soundex Last + Zip', 'DonorFirst, DonorLast, Zip', 'first2, soundex, none', '|', 5, 0],
    ['Soundex Last + First Token Address + City', 'DonorLast, Address1, City', 'soundex, first_token, lower', '|', 5, 0],
    ['First 3 First + First 3 Address + State', 'DonorFirst, Address1, State', 'first3, first3, none', '|', 5, 0],
    ['First Token First + City + Zip', 'DonorFirst, City, Zip', 'first_token, lower, none', '|', 5, 0],
    ['Soundex First + First 2 Last + City', 'DonorFirst, DonorLast, City', 'soundex, first2, lower', '|', 5, 0],
    ['First 2 First + First 2 Last + State', 'DonorFirst, DonorLast, State', 'first2, first2, none', '|', 5, 0]
  ];

  // Write the default rules starting from row 2
  sheet.getRange(2, 1, defaultRules.length, 6).setValues(defaultRules);
  Logger.log('Populated BlockingRules sheet with 50 default rules (10 per cohort)');
}
